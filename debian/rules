#!/usr/bin/make -f

export TMPDIR := $(shell mktemp -d)

%:
	dh $@


# TODO: patch preinst/postinst 'recovery_files' with list of files in `recovery/`
# TODO: revert in clean up


override_dh_install:
	# Unpack
	unsquashfs -f -d $(TMPDIR) recovery/recovery.rfs

	# Replace init script
	rm $(TMPDIR)/init || true
	cp init $(TMPDIR)

	# Copy over main OS installer script
	cp pt-os-installer $(TMPDIR)

	# Remove other NOOBS files for smaller FS file
	# https://github.com/raspberrypi/noobs/blob/master/recovery/mainwindow.cpp
	rm $(TMPDIR)/usr/bin/recovery || true  		# Actual Qt app
	rm -rf $(TMPDIR)/keymaps || true   		 		# Qt app's key mappings
	rm -rf $(TMPDIR)/usr/data || true  				# MainWindow::inputSequence's Pixmap
	rm -rf $(TMPDIR)/usr/lib/fonts/* || true  # Added system fonts

	# Repack
	rm recovery/recovery.rfs
	mksquashfs $(TMPDIR) recovery/recovery.rfs

	# Clean up temporary directory
	rm -rf $(TMPDIR)

	# Proceed with normal Debian packaging install stage
	dh_install
